## Automation blockers (headless/Excel Runner)

Источник: `extracted_vba/modules/Module1.bas`, `extracted_vba/classes/Лист3.cls`.

Ниже — **фактически найденные** блокеры/риски, с местом в коде и рекомендацией.

### 1) Event-driven auto-run (Worksheet events)

- **Где**: `extracted_vba/classes/Лист3.cls`
  - `Worksheet_Change` (триггер по `B11`)
  - `Worksheet_Calculate` (триггер по изменению `B11` после пересчёта)
  - `Worksheet_Activate` (триггер при заходе на лист)
- **Почему это проблема**:
  - В автоматизации события могут срабатывать “не вовремя” (пересчёт, активация листа, массовое заполнение ячеек) и запускать тяжёлую операцию вставки/удаления картинок.
  - Это усложняет контроль идемпотентности и времени выполнения.
- **Что делать**:
  - В runner’е держать `Application.EnableEvents = False` на время заполнения данных.
  - Не полагаться на события как на entrypoint; запускать макрос напрямую (`Module1.UpdateAllStampsFromConfig`).
  - Если будете править VBA: заменить события на явный “Run”‑макрос/кнопку, либо добавить флаг “automation mode”, чтобы события не выполнялись.

### 2) Принудительное включение событий внутри обработчика

- **Где**: `extracted_vba/classes/Лист3.cls`, строки вида:
  - `If Application.EnableEvents = False Then Application.EnableEvents = True`
- **Почему это проблема**:
  - Runner может сознательно выключать события ради стабильности; если обработчик всё же сработает, он включает события обратно и может вызвать каскад других событий.
- **Что делать**:
  - В runner’е: не активировать/не трогать этот лист во время заполнения; держать `EnableEvents=False`.
  - В VBA: убрать/ограничить это поведение (например, не включать события автоматически).

### 3) `On Error Resume Next` скрывает ошибки

- **Где**: `extracted_vba/modules/Module1.bas`, в `UpdateStampFlexible`:
  - `On Error Resume Next` вокруг `Set ws = ThisWorkbook.Sheets(sheetName)`
- **Почему это проблема**:
  - Ошибка (опечатка в имени листа, отсутствие листа) будет проглочена и обновление просто “тихо не произойдёт”.
  - В automation это выглядит как “runner отработал, но картинки не вставились”.
- **Что делать**:
  - Для runner’а: валидировать `Конфиг` заранее (имена листов должны совпадать с `workbook_map.md`).
  - В VBA: заменить на явную проверку и логирование/ошибку.

### 4) Массовое удаление всех картинок на листе

- **Где**: `extracted_vba/modules/Module1.bas`, `UpdateStampFlexible`:
  - `For Each s In ws.Shapes: If s.Type = msoPicture Then s.Delete`
- **Почему это проблема**:
  - Удалит **любые** картинки на листе, включая те, что не относятся к печатям/подписям/логотипам (если такие появятся).
  - Может быть медленно на листах с большим числом shapes.
- **Что делать**:
  - В VBA: удалять только целевые shapes (по имени, тегу, альтернативному тексту, или “зонам”).
  - В automation: считать этот макрос “разрушающим” по отношению к картинкам, не добавлять другие картинки на те же листы.

### 5) Зависимость от файловой системы (внешние файлы картинок)

- **Где**: `extracted_vba/modules/Module1.bas`
  - `Dir(pathLogo/pathStamp/pathSignDir/pathSignClient) <> ""` перед `Shapes.AddPicture`
  - Пути берутся из листа `компании` (колонки D–G)
- **Почему это проблема**:
  - Если путь неверный/файл недоступен (сетевой диск, права, UNC, относительный путь), вставка просто пропустится — без ошибки/уведомления.
- **Что делать**:
  - Runner должен подготовить файлы локально и записать **абсолютные пути** в `компании`.
  - Добавить в runner проверку “все ожидаемые файлы существуют” до запуска макроса.

### 6) Структурные допущения по листам `Конфиг` и `компании`

- **Где**: `extracted_vba/modules/Module1.bas`
  - Жёсткие номера колонок в `Конфиг` (A..I) и `компании` (A, D..G)
- **Почему это проблема**:
  - Любое изменение структуры таблиц сломает макрос.
- **Что делать**:
  - Зафиксировать структуру (не менять колонки), либо параметризовать/искать колонки по заголовкам.

## Не найдено (как отдельные блокеры)

В извлечённом VBA **не найдено**:

- `MsgBox`, `InputBox`, `UserForm.Show`
- `PrintOut`, `PrintPreview`, `ExportAsFixedFormat`
- `.Select` / `.Activate` в модулях
- `Workbooks.Open` внешних файлов
- хардкод путей вида `C:\...` / `Environ(...)` / `ThisWorkbook.Path` (пути приходят из листа `компании`)

